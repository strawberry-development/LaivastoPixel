export default class LaivastoPixel{constructor(){if(this.imageCanvas=document.getElementById("laivasto-imageCanvas"),this.pixelCanvas=document.getElementById("laivasto-pixelCanvas"),!this.imageCanvas||!this.pixelCanvas)throw new Error("Canvas elements are required.");if(this.ctxImage=this.imageCanvas.getContext("2d"),this.ctxPixel=this.pixelCanvas.getContext("2d"),!this.ctxImage||!this.ctxPixel)throw new Error("Failed to get 2D context from canvas elements.");this.controls={imageInput:document.getElementById("laivasto-imageInput"),uploadImageBtn:document.getElementById("laivasto-uploadImageBtn"),resetBtn:document.getElementById("laivasto-resetBtn"),downloadBtn:document.getElementById("laivasto-downloadBtn"),pixelSizeRange:document.getElementById("laivasto-blockSizeRange"),brightnessRange:document.getElementById("laivasto-brightnessRange"),contrastRange:document.getElementById("laivasto-contrastRange"),colorPaletteSelect:document.getElementById("laivasto-filterSelect"),gridToggle:document.getElementById("laivasto-gridToggle")},this.defaultSettings={pixelSize:10,brightness:1,contrast:1,colorPalette:"default",showGrid:!1},this.settings={...this.defaultSettings},this.originalImage=null,this.timer=null,this.resetCanvas(),this.enableControls(!1),this.initEventListeners()}initEventListeners(){const{imageInput:t,uploadImageBtn:e,resetBtn:i,downloadBtn:a,pixelSizeRange:s,brightnessRange:n,contrastRange:o,colorPaletteSelect:l,gridToggle:r}=this.controls;e.addEventListener("click",(()=>t.click())),t.addEventListener("change",(t=>{const e=t.target.files[0];e&&this.loadImage(e).then((()=>this.enableControls(!0)))}));[{range:s,prop:"blockSize",update:this.setPixelSize.bind(this)},{range:n,prop:"brightness",update:this.setBrightness.bind(this)},{range:o,prop:"contrast",update:this.setContrast.bind(this)}].forEach((({range:t,prop:e,update:i})=>{t&&t.addEventListener("input",(()=>{document.getElementById(`laivasto-${e}Value`).textContent=t.value,this.debounce((()=>i(t.value)))}))})),l&&l.addEventListener("change",(()=>{this.setColorPalette(l.value)})),i.addEventListener("click",(()=>this.resetCanvas())),a.addEventListener("click",(()=>this.downloadImage())),r.addEventListener("change",(()=>{this.setGridToggle(r.checked)}))}enableControls(t){Object.values(this.controls).forEach((e=>{"BUTTON"!==e.tagName&&"SELECT"!==e.tagName&&"range"!==e.type&&"checkbox"!==e.type||e!==this.controls.uploadImageBtn&&(e.disabled=!t,e.classList.toggle("disabled",!t))}))}async loadImage(t){try{const e=await this.readImageFile(t);this.imageCanvas.width=Math.floor(e.width/this.settings.pixelSize)*this.settings.pixelSize,this.imageCanvas.height=Math.floor(e.height/this.settings.pixelSize)*this.settings.pixelSize,this.ctxImage.drawImage(e,0,0,this.imageCanvas.width,this.imageCanvas.height),this.originalImage=this.ctxImage.getImageData(0,0,this.imageCanvas.width,this.imageCanvas.height),this.applyPixelation()}catch(t){console.error("Error loading image:",t),alert("Failed to load image. Please upload a valid image file.")}}readImageFile(t){return new Promise(((e,i)=>{const a=new FileReader;a.onload=t=>{const a=new Image;a.src=t.target.result,a.onload=()=>e(a),a.onerror=i},a.onerror=i,a.readAsDataURL(t)}))}debounce(t,e=50){clearTimeout(this.timer),this.timer=setTimeout(t,e)}setPixelSize(t){this.settings.pixelSize=Math.max(1,parseInt(t,10)),this.applyPixelation()}setBrightness(t){this.settings.brightness=parseFloat(t),this.applyPixelation()}setContrast(t){this.settings.contrast=parseFloat(t),this.applyPixelation()}setColorPalette(t){this.settings.colorPalette=t,this.applyPixelation()}setGridToggle(t){this.settings.showGrid=t,this.applyPixelation()}applyPixelation(){if(!this.originalImage)return;const{pixelSize:t,showGrid:e}=this.settings,{width:i,height:a}=this.originalImage;this.pixelCanvas.width=i,this.pixelCanvas.height=a,this.ctxPixel.clearRect(0,0,i,a);const s=this.originalImage.data,n=Math.floor(a/t),o=Math.floor(i/t);for(let e=0;e<n;e++)for(let a=0;a<o;a++){const n=a*t,o=e*t,l=[0,0,0];this.getAverageColor(s,n,o,i,t,l);const r=this.adjustColor(l),h=this.applyPalette(r);this.ctxPixel.fillStyle=`rgb(${h.join(", ")})`,this.ctxPixel.fillRect(n,o,t,t)}e&&this.drawGrid()}getAverageColor(t,e,i,a,s,n){let o=0,l=0,r=0;const h=s*s,g=4*(i*a+e);for(let e=0;e<s;e++)for(let i=0;i<s;i++){const s=g+4*(e*a+i);o+=t[s],l+=t[s+1],r+=t[s+2]}n[0]=o/h,n[1]=l/h,n[2]=r/h}adjustColor([t,e,i]){const{brightness:a,contrast:s}=this.settings;return[t,e,i].map((t=>Math.min(255,Math.max(0,Math.round(s*t*a)))))}applyPalette(t){const e={grayscale:this.toGrayscale,pastel:this.toPastel,negative:this.toNegative,sepia:this.toSepia,vibrant:this.toVibrant,retro:this.toRetro,neon:this.toNeon,muted:this.toMuted,warm:this.toWarm,cool:this.toCool,vintage:this.toVintage,highContrast:this.toHighContrast,nightMode:this.toNightMode,blackAndWhite:this.toBlackAndWhite,solarized:this.toSolarized}[this.settings.colorPalette];return e?e(t):t}toGrayscale([t,e,i]){const a=(t+e+i)/3;return[a,a,a]}toPastel([t,e,i]){return[Math.min(255,t+100),Math.min(255,e+100),Math.min(255,i+100)]}toNegative([t,e,i]){return[255-t,255-e,255-i]}toSepia([t,e,i]){return[Math.min(255,.393*t+.769*e+.189*i),Math.min(255,.349*t+.686*e+.168*i),Math.min(255,.272*t+.534*e+.131*i)]}toVibrant([t,e,i]){return[Math.min(255,1.2*t),Math.min(255,1.2*e),Math.min(255,1.2*i)]}toRetro([t,e,i]){return[t<128?1.2*t:.8*t,e<128?1.2*e:.8*e,i<128?1.2*i:.8*i]}toNeon([t,e,i]){return[Math.min(255,t+100),Math.min(255,e+100),Math.min(255,i+100)]}toMuted([t,e,i]){return[.8*t,.8*e,.8*i]}toWarm([t,e,i]){return[Math.min(255,t+50),e,Math.max(0,i-50)]}toCool([t,e,i]){return[Math.max(0,t-50),e,Math.min(255,i+50)]}toVintage([t,e,i]){return[Math.min(255,.9*t+40),Math.min(255,.85*e+30),Math.min(255,.7*i+20)]}toHighContrast([t,e,i]){return[t>128?Math.min(255,1.5*t):Math.max(0,.5*t),e>128?Math.min(255,1.5*e):Math.max(0,.5*e),i>128?Math.min(255,1.5*i):Math.max(0,.5*i)]}toNightMode([t,e,i]){return[Math.max(0,.5*t),Math.max(0,.5*e),Math.min(255,1.5*i)]}toBlackAndWhite([t,e,i]){return(t+e+i)/3>128?[255,255,255]:[0,0,0]}toSolarized([t,e,i]){return[t>128?255-t:1.2*t,e>128?255-e:1.2*e,i>128?255-i:1.2*i]}resetCanvas(){this.settings={...this.defaultSettings},this.applyControls(),this.applyPixelation()}applyControls(){const{pixelSizeRange:t,brightnessRange:e,contrastRange:i,colorPaletteSelect:a,gridToggle:s}=this.controls,{pixelSize:n,brightness:o,contrast:l,colorPalette:r,showGrid:h}=this.settings;t&&(t.value=n),e&&(e.value=o),i&&(i.value=l),a&&(a.value=r),s&&(s.checked=h),document.getElementById("laivasto-blockSizeValue").textContent=n,document.getElementById("laivasto-brightnessValue").textContent=o,document.getElementById("laivasto-contrastValue").textContent=l}downloadImage(){const t=document.createElement("a");t.href=this.pixelCanvas.toDataURL("image/png"),t.download="pixelated_image.png",t.click()}drawGrid(){const{pixelSize:t}=this.settings,{width:e,height:i}=this.pixelCanvas;this.ctxPixel.strokeStyle="rgba(0, 0, 0, 0.1)";for(let a=0;a<e;a+=t)this.ctxPixel.beginPath(),this.ctxPixel.moveTo(a,0),this.ctxPixel.lineTo(a,i),this.ctxPixel.stroke();for(let a=0;a<i;a+=t)this.ctxPixel.beginPath(),this.ctxPixel.moveTo(0,a),this.ctxPixel.lineTo(e,a),this.ctxPixel.stroke()}}